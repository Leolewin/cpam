<?xml version="1.0"?>
<programs>
  <program name="openssl" version="0.9.7b" revision="5">
    <build-name>${SB_PROG_NAME}-${SB_PROG_VER}</build-name>

    <sources>
      <source checksum="fae4bec090fa78e20f09d76d55b6ccff"
        checksum-type="md5" size="2784331"
        path="src/openssl-0.9.7b.tar.gz"/>
      <patch checksum="10253ee9ce1b351914c17b8c80ea234d"
        checksum-type="md5" size="20151"
        path="src/openssl-0.9.7b.patch"/>
    </sources>

    <dependencies>
      <depend program="gcc" add-path="prepend">v==3.3.2</depend>
      <depend program="perl" var="PERL" add-path="prepend"
        type="build">v==5.8.2</depend>
    </dependencies>

    <module name="default">
      <install-name>lib${SB_PROG_NAME}097</install-name>

      <configure>
<![CDATA[
case "${SB_SYSTYPE}" in
*-aix*)
  ARCH=aix43-cc ;;
*-osf*)
  ARCH=alpha-cc ;;
*-hpux*)
  ARCH=hpux-parisc-cc ;;
*-irix6*)
  ARCH=irix-mips3-cc ;;
x86_64-*-linux*)
  ARCH=linux-x86_64 ;;
*-linux*)
  ARCH=linux-elf ;;
*-solaris2.[89])
  ARCH=solaris-sparcv8-gcc ;;
*-solaris2*)
  ARCH=solaris-sparcv7-cc ;;
esac

case "${SB_SYSTYPE}" in
*-aix5.2*|*-linux*|*-solaris2.[89])
  PERL=${SB_VAR_PERL}/bin/perl ./Configure ${ARCH} no-idea shared \
  --openssldir=${SB_INSTALL_PREFIX} --prefix=${SB_INSTALL_PREFIX} ;;
*)
  PRNGD_SOCKET=/var${PRNGD}/pool

  # set path to PRNGD socket
  sed -e "s!^is located at.*!is located at ${PRNGD_SOCKET}.!" \
  doc/crypto/RAND_egd.pod >/tmp/$$
  cp /tmp/$$ doc/crypto/RAND_egd.pod && rm /tmp/$$

  PERL=${SB_VAR_PERL}/bin/perl ./Configure ${ARCH} no-idea shared \
  -DDEVRANDOM_EGD=\"${PRNGD_SOCKET}\" \
  --openssldir=${SB_INSTALL_PREFIX} --prefix=${SB_INSTALL_PREFIX} ;;
esac
]]>
      </configure>

      <build>
<![CDATA[
case "${SB_SYSTYPE}" in
*-aix*)
  LDFLAGS="-Wl,-blibpath:/usr/lib" ;;
esac

gmake LDFLAGS="${LDFLAGS+${LDFLAGS}}"
]]>
      </build>

      <install>
<![CDATA[
case "${SB_SYSTYPE}" in
*-aix*)
  LDFLAGS="-Wl,-blibpath:/usr/lib"
  RPATH="-Wl,-blibpath:" ;;
*-osf*|*-irix*)
  RPATH="-rpath " ;;
*-hpux*)
  RPATH="+s +b " CC_LD_RT="-Wl,+s,+b," ;;
*-linux*)
  RPATH="-Wl,-rpath," ;;
*-solaris*)
  RPATH="-R" ;;
esac

gmake MAKE=gmake RPATH="${RPATH}${SB_INSTALL_PREFIX}/lib \
${LDFLAGS+${LDFLAGS}}" install

# Embed runtime library path in openssl binary
(rm apps/openssl
gmake LIBSSL="-L${SB_INSTALL_PREFIX}/lib \
${CC_LD_RT:-${RPATH}}${SB_INSTALL_PREFIX}/lib -lssl ${LDFLAGS+${LDFLAGS}}" \
LIBCRYPTO="-L${SB_INSTALL_PREFIX}/lib -lcrypto" DIRS=apps sub_all
ginstall -m 755 -o root -g 0 apps/openssl ${SB_INSTALL_PREFIX}/bin)

# Fix library path in pkgconfig file
sed "s!-L\(\${libdir}\)!-L\1 ${CC_LD_RT:-${RPATH}}\1!" \
${SB_INSTALL_PREFIX}/lib/pkgconfig/openssl.pc >/tmp/$$
cp /tmp/$$ ${SB_INSTALL_PREFIX}/lib/pkgconfig/openssl.pc && rm /tmp/$$

# c_rehash seems to be useless
rm ${SB_INSTALL_PREFIX}/bin/c_rehash
]]>
      </install>
    </module>

    <module name="tww-static">
      <install-name>lib${SB_PROG_NAME}097s</install-name>

      <configure>
<![CDATA[
case "${SB_SYSTYPE}" in
*-aix*)
  ARCH=aix43-cc ;;
*-osf*)
  ARCH=alpha-cc ;;
*-hpux*)
  ARCH=hpux-parisc-cc ;;
*-irix6*)
  ARCH=irix-mips3-cc ;;
x86_64-*-linux*)
  ARCH=linux-x86_64 ;;
*-linux*)
  ARCH=linux-elf ;;
*-solaris2.[89])
  ARCH=solaris-sparcv8-gcc ;;
*-solaris2*)
  ARCH=solaris-sparcv7-cc ;;
esac

case "${SB_SYSTYPE}" in
*-aix5.2*|*-linux*|*-solaris2.[89])
  PERL=${SB_VAR_PERL}/bin/perl ./Configure ${ARCH} no-idea no-shared \
  --openssldir=${SB_INSTALL_PREFIX} --prefix=${SB_INSTALL_PREFIX} ;;
*)
  PRNGD_SOCKET=/var${PRNGD}/pool

  # set path to PRNGD socket
  sed -e "s!^is located at.*!is located at ${PRNGD_SOCKET}.!" \
  doc/crypto/RAND_egd.pod >/tmp/$$
  cp /tmp/$$ doc/crypto/RAND_egd.pod && rm /tmp/$$

  PERL=${SB_VAR_PERL}/bin/perl ./Configure ${ARCH} no-idea no-shared \
  -DDEVRANDOM_EGD=\"${PRNGD_SOCKET}\" \
  --openssldir=${SB_INSTALL_PREFIX} --prefix=${SB_INSTALL_PREFIX} ;;
esac
]]>
      </configure>
    </module>

    <notes>
      <note type="usage">
        <para>Beginning with OpenSSL 0.9.7, the PRNGd daemon will be
queried automatically for entropy on systems lacking
<command>/dev/random</command>. The default path to the PRNGd socket
is <command>/var${SB_INSTALL_BASE}/prngd/pool</command>. This is a compile-time setting
and cannot be changed at runtime.</para>

        <para>64-bit binaries are available for AIX 5.1, IRIX 6.5,
HP-UX 11.x, and Solaris 7, 8, and 9/SPARC.</para>
      </note>
    </notes>

    <changelog>
      <change date="2004 August 8" revision="5"
      author="Albert Chin-A-Young" email="china@thewrittenword.com">
        <item><para>Support for RHEL 3.0/AMD64</para></item>
      </change>

      <change date="2004 March 18" revision="4"
      author="Albert Chin-A-Young" email="china@thewrittenword.com">
        <item><para>Add support for AIX 5.2 (has
<command>/dev/random</command>)</para></item>
      </change>

      <change date="2004 March 17" revision="3"
      author="Albert Chin-A-Young" email="china@thewrittenword.com">
        <item><para>Security fix for null-pointer assignment during
SSL handshake (cf. <ulink url="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CAN-2004-0079">http://cve.mitre.org/cgi-bin/cvename.cgi?name=CAN-2004-0079</ulink>)</para></item>
        <item><para>Security fix for out-of-bounds read affecting
Kerberos ciphersuites (cf. <ulink url="http://cve.mitre.org/cgi-bin/cvename.cgi?name=CAN-2004-0112">http://cve.mitre.org/cgi-bin/cvename.cgi?name=CAN-2004-0112</ulink>)</para></item>
        <item><para>Fix to earlier ssl3_accept() patch (forgot to
remove code replaced by patch)</para></item>
      </change>

      <change date="2003 September 30" revision="2"
      author="Albert Chin-A-Young" email="china@thewrittenword.com">
        <item><para>Merge patches for four security vulnerabilities
(<ulink url="http://www.openssl.org/news/secadv_20030930.txt">http://www.openssl.org/news/secadv_20030930.txt</ulink>)</para></item>
        <item><para>In ssl3_accept() (ssl/s3_srvr.c) only accept a
client certificate if the server requested one: as stated in TLS 1.0
and SSL 3.0 specifications</para></item>
      </change>

      <change date="2003 July 14" revision="1"
      author="Albert Chin-A-Young" email="china@thewrittenword.com">
        <item><para>Change -m486 to -mcpu=i486 in linux-elf for GCC
3.2.x in Redhat Linux 9.0</para></item>
      </change>
    </changelog>
  </program>
</programs>
