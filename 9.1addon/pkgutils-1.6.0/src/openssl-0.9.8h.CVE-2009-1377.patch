
 http://cvs.openssl.org/chngview?cn=18187

Index: crypto/pqueue/pqueue.c
===================================================================
--- crypto/pqueue/pqueue.c.orig	2005-06-28 12:53:33.000000000 +0000
+++ crypto/pqueue/pqueue.c	2010-03-04 21:29:01.670460786 +0000
@@ -234,3 +234,17 @@
 
 	return ret;
 	}
+
+int
+pqueue_size(pqueue_s *pq)
+{
+	pitem *item = pq->items;
+	int count = 0;
+
+	while(item != NULL)
+	{
+		count++;
+		item = item->next;
+	}
+	return count;
+}
Index: crypto/pqueue/pqueue.h
===================================================================
--- crypto/pqueue/pqueue.h.orig	2005-05-30 22:34:27.000000000 +0000
+++ crypto/pqueue/pqueue.h	2010-03-04 21:29:01.676168783 +0000
@@ -91,5 +91,6 @@
 pitem *pqueue_next(piterator *iter);
 
 void   pqueue_print(pqueue pq);
+int    pqueue_size(pqueue pq);
 
 #endif /* ! HEADER_PQUEUE_H */
Index: ssl/d1_pkt.c
===================================================================
--- ssl/d1_pkt.c.orig	2007-10-17 21:17:49.000000000 +0000
+++ ssl/d1_pkt.c	2010-03-04 21:29:01.698666917 +0000
@@ -167,6 +167,10 @@
     DTLS1_RECORD_DATA *rdata;
 	pitem *item;
 
+	/* Limit the size of the queue to prevent DOS attacks */
+	if (pqueue_size(queue->q) >= 100)
+		return 0;
+
 	rdata = OPENSSL_malloc(sizeof(DTLS1_RECORD_DATA));
 	item = pitem_new(priority, rdata);
 	if (rdata == NULL || item == NULL)
