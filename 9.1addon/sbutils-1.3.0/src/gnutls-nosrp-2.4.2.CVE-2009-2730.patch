Index: lib/gnutls_str.c
===================================================================
--- lib/gnutls_str.c.orig	2008-09-15 20:04:19.000000000 +0000
+++ lib/gnutls_str.c	2009-10-18 08:47:15.315966906 +0000
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2002, 2004, 2005, 2007, 2008  Free Software Foundation
+ * Copyright (C) 2002, 2004, 2005, 2007, 2008, 2009  Free Software Foundation
  *
  * Author: Nikos Mavrogiannopoulos
  *
@@ -331,35 +331,42 @@
 
 /* compare hostname against certificate, taking account of wildcards
  * return 1 on success or 0 on error
+ *
+ * note: certnamesize is required as X509 certs can contain embedded NULs in
+ * the strings such as CN or subjectAltName
  */
 int
-_gnutls_hostname_compare (const char *certname, const char *hostname)
-{
-   /* find the first different character */
-  for (; *certname && *hostname && toupper(*certname) == toupper(*hostname); certname++, hostname++)
+_gnutls_hostname_compare (const char *certname,
+			  size_t certnamesize,
+			  const char *hostname)
+{
+  /* find the first different character */
+  for (; *certname && *hostname && toupper (*certname) == toupper (*hostname);
+       certname++, hostname++, certnamesize--)
     ;
- 
-   /* the strings are the same */
-  if (strlen (certname) == 0 && strlen (hostname) == 0)
+
+  /* the strings are the same */
+  if (certnamesize == 0 && *hostname == '\0')
     return 1;
-  
+
   if (*certname == '*')
     {
       /* a wildcard certificate */
 
       certname++;
-  
+      certnamesize--;
+
       while (1)
-       	{
+	{
 	  /* Use a recursive call to allow multiple wildcards */
-	  if (_gnutls_hostname_compare (certname, hostname))
- 	    {
- 	      return 1;
- 	    }
- 	  /* wildcards are only allowed to match a single domain component or component fragment */
- 	  if (*hostname == '\0' || *hostname == '.')
- 	    break;
- 	  hostname++;
+	  if (_gnutls_hostname_compare (certname, certnamesize, hostname))
+	    return 1;
+
+	  /* wildcards are only allowed to match a single domain
+	     component or component fragment */
+	  if (*hostname == '\0' || *hostname == '.')
+	    break;
+	  hostname++;
 	}
 
       return 0;
Index: lib/gnutls_str.h
===================================================================
--- lib/gnutls_str.h.orig	2008-09-15 20:04:19.000000000 +0000
+++ lib/gnutls_str.h	2009-10-18 08:47:17.731733982 +0000
@@ -62,7 +62,7 @@
 int _gnutls_hex2bin (const opaque * hex_data, int hex_size, opaque * bin_data,
 		     size_t * bin_size);
 
-int _gnutls_hostname_compare (const char *certname, const char *hostname);
+int _gnutls_hostname_compare (const char *certname, size_t certnamesize, const char *hostname);
 #define MAX_CN 256
 
 #endif
Index: lib/openpgp/pgp.c
===================================================================
--- lib/openpgp/pgp.c.orig	2008-09-15 20:04:19.000000000 +0000
+++ lib/openpgp/pgp.c	2009-10-18 08:47:22.280165864 +0000
@@ -566,7 +566,7 @@
       
       if (ret == 0)
         {
-          if (_gnutls_hostname_compare (dnsname, hostname))
+          if (_gnutls_hostname_compare (dnsname, dnsnamesize, hostname))
             return 1;
         }
     }
Index: lib/x509/common.c
===================================================================
--- lib/x509/common.c.orig	2008-09-15 20:04:19.000000000 +0000
+++ lib/x509/common.c	2009-10-18 08:47:31.067799736 +0000
@@ -1,5 +1,5 @@
 /*
- * Copyright (C) 2003, 2004, 2005, 2006, 2007, 2008 Free Software Foundation
+ * Copyright (C) 2003, 2004, 2005, 2006, 2007, 2008, 2009 Free Software Foundation
  *
  * Author: Nikos Mavrogiannopoulos
  *
@@ -241,6 +241,10 @@
     {
       str[len] = 0;
 
+      /* Refuse to deal with strings containing NULs. */
+      if (strlen (str) != len)
+	return GNUTLS_E_ASN1_DER_ERROR;
+
       if (res)
 	_gnutls_str_cpy (res, *res_size, str);
       *res_size = len;
@@ -291,25 +295,27 @@
 	    non_printable = 0;
 	}
 
-      if (res)
+      if (non_printable == 0)
 	{
-	  if (non_printable == 0)
-	    {
-	      str[len] = 0;
-	      _gnutls_str_cpy (res, *res_size, str);
-	      *res_size = len;
-	    }
-	  else
+	  str[len] = 0;
+
+	  /* Refuse to deal with strings containing NULs. */
+	  if (strlen (str) != len)
+	    return GNUTLS_E_ASN1_DER_ERROR;
+
+	  if (res)
+	    _gnutls_str_cpy (res, *res_size, str);
+	  *res_size = len;
+	}
+      else
+	{
+	  result = _gnutls_x509_data2hex (str, len, res, res_size);
+	  if (result < 0)
 	    {
-	      result = _gnutls_x509_data2hex (str, len, res, res_size);
-	      if (result < 0)
-		{
-		  gnutls_assert ();
-		  return result;
-		}
+	      gnutls_assert ();
+	      return result;
 	    }
 	}
-
     }
 
   return 0;
Index: lib/x509/output.c
===================================================================
--- lib/x509/output.c.orig	2008-09-15 20:04:19.000000000 +0000
+++ lib/x509/output.c	2009-10-18 08:47:33.668082563 +0000
@@ -272,6 +272,17 @@
 	  return;
 	}
 
+      if ((err == GNUTLS_SAN_DNSNAME
+	   || err == GNUTLS_SAN_RFC822NAME
+	   || err == GNUTLS_SAN_URI) &&
+	  strlen (buffer) != size)
+	{
+	  adds (str, _("warning: distributionPoint contains an embedded NUL, "
+		       "replacing with '!'\n"));
+	  while (strlen (buffer) < size)
+	    buffer[strlen (buffer)] = '!';
+	}
+
       switch (err)
 	{
 	case GNUTLS_SAN_DNSNAME:
@@ -423,6 +434,17 @@
 	  return;
 	}
 
+      if ((err == GNUTLS_SAN_DNSNAME
+	   || err == GNUTLS_SAN_RFC822NAME
+	   || err == GNUTLS_SAN_URI) &&
+	  strlen (buffer) != size)
+	{
+	  adds (str, _("warning: SAN contains an embedded NUL, "
+		       "replacing with '!'\n"));
+	  while (strlen (buffer) < size)
+	    buffer[strlen (buffer)] = '!';
+	}
+
       switch (err)
 	{
 	case GNUTLS_SAN_DNSNAME:
@@ -481,7 +503,16 @@
 	      }
 
 	    if (err == GNUTLS_SAN_OTHERNAME_XMPP)
+	      {
+		if (strlen (buffer) != size)
+		  {
+		    adds (str, _("warning: SAN contains an embedded NUL, "
+				 "replacing with '!'\n"));
+		    while (strlen (buffer) < size)
+		      buffer[strlen (buffer)] = '!';
+		  }
 	      addf (str, _("\t\t\tXMPP Address: %.*s\n"), size, buffer);
+	      }
 	    else
 	      {
 		addf (str, _("\t\t\totherName OID: %.*s\n"), oidsize, oid);
Index: lib/x509/rfc2818_hostname.c
===================================================================
--- lib/x509/rfc2818_hostname.c.orig	2008-09-15 20:04:19.000000000 +0000
+++ lib/x509/rfc2818_hostname.c	2009-10-18 08:47:37.637663222 +0000
@@ -74,17 +74,17 @@
       if (ret == GNUTLS_SAN_DNSNAME)
 	{
 	  found_dnsname = 1;
-	  if (_gnutls_hostname_compare (dnsname, hostname))
+	  if (_gnutls_hostname_compare (dnsname, dnsnamesize, hostname))
 	    {
 	      return 1;
 	    }
 	}
       else if (ret == GNUTLS_SAN_IPADDRESS)
 	{
-	  found_dnsname = 1; /* RFC 2818 is unclear whether the CN
-				should be compared for IP addresses
-				too, but we won't do it.  */
-	  if (_gnutls_hostname_compare (dnsname, hostname))
+	  found_dnsname = 1;	/* RFC 2818 is unclear whether the CN
+				   should be compared for IP addresses
+				   too, but we won't do it.  */
+	  if (_gnutls_hostname_compare (dnsname, dnsnamesize, hostname))
 	    {
 	      return 1;
 	    }
@@ -104,7 +104,7 @@
 	  return 0;
 	}
 
-      if (_gnutls_hostname_compare (dnsname, hostname))
+      if (_gnutls_hostname_compare (dnsname, dnsnamesize, hostname))
 	{
 	  return 1;
 	}
