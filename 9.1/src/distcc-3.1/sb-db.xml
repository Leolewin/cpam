<?xml version="1.0"?>
<programs>
<!DOCTYPE programs SYSTEM "sb-db.dtd">
  <program name="distcc" version="3.1" revision="2">
    <build-name>${SB_PROG_NAME}-${SB_PROG_VER}</build-name>

    <install-name>${SB_PROG_NAME}31</install-name>

    <sources>
      <source checksum="a1a9d3853df7133669fffec2a9aab9f3"
        checksum-type="md5" size="588820"
        path="src/distcc-3.1.tar.bz2"/>
      <patch checksum="44a8490fcfece709c582f558c6247f25"
        checksum-type="md5" size="15663"
        path="src/distcc-3.1.tww.patch"/>
      <patch checksum="cf75b0df0b8d94e9a12e870c44a17663"
        checksum-type="md5" size="148622"
        path="src/distcc-3.1.gnulib.patch"/>
      <patch checksum="d9918a0de246d8dfe90328b372e4c263"
        checksum-type="md5" size="722747"
        path="src/distcc-3.1.auto.patch"/>
    </sources>

    <dependencies>
      <depend user="distcc"/>

      <depend program="bison" install-name="bison24"
        add-path="prepend" type="build">v&gt;=2.4.3</depend>
      <depend program="popt" var="LIBPOPT"
        install-name="libpopt116">v&gt;=1.16</depend>
    </dependencies>

    <validate>
      <depend program="distcc" module="python">v==3.1</depend>
    </validate>

    <script-header>
<![CDATA[
_datadir="${SB_INSTALL_PREFIX}/share"
_docdir="${SB_INSTALL_PREFIX}/doc"
_localstatedir="/var${SB_INSTALL_PREFIX}"
_sysconfdir="${SB_INSTALL_PREFIX}/etc"
]]>
    </script-header>

    <purge>
<![CDATA[
# sbutils gets confused by the symlinks in
# ${SB_BUILD_PREFIX}/include_server/test_data/symlink_farm/*
rm -rf ${SB_BUILD_PREFIX}
]]>
    </purge>

    <module name="default">
      <script-header>
<![CDATA[
_datadir="${SB_INSTALL_PREFIX}/share"
_docdir="${SB_INSTALL_PREFIX}/doc"
_localstatedir="/var${SB_INSTALL_PREFIX}"
_sysconfdir="${SB_INSTALL_PREFIX}/etc"
]]>
      </script-header>

      <configure>
<![CDATA[
case "${SB_SYSTYPE}" in
*-aix*)
  CC=xlc CFLAGS="-O2 -qro -qroconst -qmaxmem=-1 -qarch=ppc"
  LDFLAGS="-Wl,-brtl -Wl,-blibpath:/usr/lib"
  CC_LD_RT="-Wl,-blibpath:" ;;
ia64*-hpux*)
  CC=cc CFLAGS="-Ae -z +O2 +Ofltacc +Olit=all +Oentrysched \
+Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+b," ;;
*-hpux11.[01]*)
  CC=cc CFLAGS="-Ae -z +O2 +Ofltacc +ESlit +DAportable \
+Oentrysched +Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+s,+b," ;;
*-hpux*)
  CC=cc CFLAGS="-Ae -z +O2 +Ofltacc +Olit=all +Oentrysched \
+Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+s,+b," ;;
*-irix*)
  CC=cc CFLAGS="-Wl,-woff,84 -Wl,-woff,85 -woff 1009,1429 \
-use_readonly_const -G0 -rdata_shared -DEBUG:optimize_space=ON \
-O2 -OPT:Olimit=0"
  CC_LD_RT="-Wl,-rpath," ;;
i?86*-linux*)
  CFLAGS="-O2 -mtune=pentium4 -march=pentium4"
  CC_LD_RT="-Wl,-rpath," ;;
*-linux*)
  CC_LD_RT="-Wl,-rpath," ;;
*-osf*)
  CC=cc CFLAGS="-O2 -arch ev5 -msym -readonly_strings"
  CC_LD_RT="-Wl,-rpath,"

  # No sendfile support (even though libc.so has a sendfile symbol)
  export ac_cv_func_sendfile=no ;;
i?86*-solaris*)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=pentium4"
  CC_LD_RT="-R" ;;
*-solaris2.8)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=ultra2 \
-xarch=v8plusa"
  CC_LD_RT="-R" ;;
*-solaris*)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=ultra2 \
-m32 -xarch=sparcvis"
  CC_LD_RT="-R" ;;
esac

${SHELL} ./configure CC="${CC:-gcc}" CFLAGS="${CFLAGS:--O2}" \
CPPFLAGS="-I${SB_VAR_LIBPOPT_INC}" LDFLAGS="-L${SB_VAR_LIBPOPT_LIB} \
${CC_LD_RT}${SB_VAR_LIBPOPT_LIB} ${LDFLAGS+${LDFLAGS}}" \
--without-avahi ${ARGS+$ARGS} --with-docdir=${_docdir} \
--datarootdir=${_datadir} --datadir=${_datadir} \
--sysconfdir=${_sysconfdir} --mandir="${SB_INSTALL_PREFIX}/man" \
--prefix=${SB_INSTALL_PREFIX}
]]>
      </configure>

      <build>
<![CDATA[
# First build gnulib - distcc doesn't use Automake, so we have to
# do it manually (without porting the toplevel Makefile to Automake):
gmake -C lib

gmake distcc distccd distccmon-text lsdistcc pkgdatadir=${_datadir}
]]>
      </build>

      <test auto-include="0">
        <dependencies>
          <depend program="python" add-path="prepend">v==2.6.7</depend>
        </dependencies>
<![CDATA[
# Test suite might require large number of process/user. AIX/HP-UX
# leave around distccd processes.
gmake maintainer-check

: ignore test failures
]]>
      </test>

      <install>
<![CDATA[
gmake showpaths install-doc install-man install-programs \
install-example install-conf showpaths pkgdatadir=${_datadir}

${SB_PATH_SED} -i -e "\
s!/etc/distcc!${_sysconfdir}!; \
s!/etc/site/current/distcc!${_sysconfdir}!;" \
${_sysconfdir}/hosts ${_sysconfdir}/commands.allow.sh

if [ "${_localstatedir+set}" = set ]; then
  ${SB_PATH_INSTALL} -m 755 -o distcc -g 0 -d ${_localstatedir}/run
fi
]]>
      </install>

      <uninstall>
<![CDATA[
rm -rf ${_localstatedir+${_localstatedir}} ${SB_INSTALL_PREFIX}
]]>
      </uninstall>

      <purge>
<![CDATA[
# sbutils gets confused by the symlinks in
# ${SB_BUILD_PREFIX}/include_server/test_data/symlink_farm/*
rm -rf ${SB_BUILD_PREFIX}
]]>
      </purge>
    </module>

    <module name="python">
      <dependencies>
        <depend program="gcc" install-name="gcc44" add-path="prepend"
          type="build">v&gt;=4.4.6</depend>
        <depend program="python" install-name="python26"
          add-path="prepend">v&gt;=2.6.7</depend>
      </dependencies>

      <script-header>
<![CDATA[
_datadir="${SB_INSTALL_PREFIX}/share"
_docdir="${SB_INSTALL_PREFIX}/doc"
_localstatedir="/var${SB_INSTALL_PREFIX}"
_sysconfdir="${SB_INSTALL_PREFIX}/etc"
]]>
      </script-header>

      <configure>
<![CDATA[
${SHELL} ./configure --without-avahi --with-docdir=${_docdir} \
--datarootdir=${_datadir} --datadir=${_datadir} \
--sysconfdir=${_sysconfdir} --mandir="${SB_INSTALL_PREFIX}/man" \
--prefix=${SB_INSTALL_PREFIX}
]]>
      </configure>

      <build>
<![CDATA[
gmake include-server pkgdatadir=${_datadir}
]]>
      </build>

      <install>
<![CDATA[
gmake install-include-server pkgdatadir=${_datadir}
]]>
      </install>

      <uninstall>
<![CDATA[
rm -rf ${SB_INSTALL_PREFIX}/bin/pump
rm -rf ${SB_INSTALL_PREFIX}/lib/python26
]]>
      </uninstall>

      <purge>
<![CDATA[
# sbutils gets confused by the symlinks in
# ${SB_BUILD_PREFIX}/include_server/test_data/symlink_farm/*
rm -rf ${SB_BUILD_PREFIX}
]]>
      </purge>
    </module>

    <licenses>
      <license path="gpl-2.license"/>
    </licenses>

    <notes>
      <change from="3.0" to="3.1">
        <items name="Features">
          <item><para>New "--scan-includes" option to distcc.  This
shows which headers distcc would send to the remote machine in pump
mode, without actually compiling anything.  This provides a simple
interface to the include server.</para></item>
          <item><para>New "--disable-Werror" option to configure. This
disables the use of gcc's -Werror option when building distcc,
allowing compilation of distcc to succeed even if gcc issues
warnings.</para></item>
        </items>

        <items name="Documentation">
          <item><para>Document all of the exit codes in the man
page</para></item>
        </items>

        <items name="Bug Fixes">
          <item><para>Handle "-Wp,-MMD,...".</para></item>
          <item><para>Report a better error message if a host
specification contains ",cpp" but not ",lzo".</para></item>
          <item><para>Fix a bug where the "m4" directory wasn't
included in the source distribution tarball, which caused it to stop
working if you ran autogen.sh.</para></item>
        </items>

        <items name="Portability">
          <item><para>Fixed a bug where the pump script was
hard-coding /etc/distcc/hosts rather than using the prefix specified
to configure.</para></item>
          <item><para>Fixed build errors on Gentoo Linux and some
other systems</para></item>
        </items>
      </change>

      <change from="3.0rc4" to="3.0">
        <items name="Documentation">
          <item><para>Minor improvements to the man
pages.</para></item>
        </items>
      </change>

      <change from="3.0rc3" to="3.0rc4">
        <items name="Bug Fixes">
          <item><para>Fixed a bug in 3.0rc3 that broke pump mode for
C++ compilations that use -I options that refer to a subdirectory of
one of the default system include directories, e.g.
-I/usr/include/foo.</para></item>
        </items>
      </change>

      <change from="3.0rc2" to="3.0rc3">
        <items name="Features">
          <item><para>New "--without-avahi" option to
configure.</para></item>
        </items>

        <items name="Bug Fixes">
          <item><para>Fixed a problem where pump mode was falling back
to local compilation when compiling with -I options that refer to a
subdirectory of one of the default system include
directories.</para></item>
          <item><para>Allow distcc to distribute commands that use
"-MF&lt;filename&gt;" rather than "-MF &lt;filename&gt;", and likewise
for "-MT &lt;target&gt;".</para></item>
        </items>

        <items name="Portability">
          <item><para>Fixed a build problem on ARM and Solaris
systems.</para></item>
          <item><para>Fixed a build problem on some Linux
systems.</para></item>
          <item><para>Fixed failure of "make install" on
Cygwin.</para></item>
        </items>
      </change>

      <change from="3.0rc1" to="3.0rc1">
        <items name="Bug Fixes">
          <item><para>Fallback to local compilation for
"-march=native" or "mtune=native"</para></item>
          <item><para>Fix for deadlock in pump mode.</para></item>
        </items>
      </change>

      <change from="2.18.3" to="3.0r1">
        <items name="Features">
          <item><para>New protocol, version 3, allowing for
preprocessing on distcc servers ("pump" mode).</para></item>
          <item><para>New component: an include server for incremental
static analysis of include dependencies.  This software is written in
Python 2.4.</para></item>
          <item><para>Support for getting hosts via
avahi</para></item>
        </items>

        <items name="Bug Fixes">
          <item><para>gcc debug option -d must be run locally because
it produces secondary files.</para></item>
          <item><para>Improved checking for errors on socket
connection.</para></item>
        </items>

        <items name="Portability">
          <item><para>"Pump" code tested under Linux only.  Processing
of object code rewrites debug info (so server paths are replaced with
client paths), but this works for ELF code only.</para></item>
          <item><para>Fix failure of 'make maintainer-check' in
non-English locales.</para></item>
          <item><para>Locks taken through F_SETLK or lockf() must be
explicitly released, because closing the file does not do
so.</para></item>
          <item><para>Use python2.4 if available.</para></item>
          <item><para>Execute compiler with correctly redirected
output using win32 apis on Cygwin/Mingw.  Place temporary files using
GetTempPath.</para></item>
          <item><para>Make distccmon-gnome link properly with gnu ld's
new --as-needed flag.</para></item>
        </items>

        <items name="Other Changes">
          <item><para><ulink url="http://distcc.googlecode.com">New web site</ulink>.</para></item>
          <item><para><ulink url="http://distcc.googlecode.com/svn/trunk">New repository</ulink>.</para></item>
          <item><para>New maintainer: Fergus Henderson.</para></item>
        </items>
      </change>

      <change from="2.18.2" to="2.18.3">
        <items name="Bug Fixes">
          <item><para>Fix for incorrect handling of -x and
-specs</para></item>
        </items>

        <items name="Tests">
          <item><para>Fix false pass in tests for -x and
-specs.</para></item>
        </items>
      </change>

      <change from="2.18.1" to="2.18.2">
        <items name="Bug Fixes">
          <item><para>Fix problem in checking errno after
connect().</para></item>
        </items>

        <items name="Portability">
          <item><para>Fix prototype problem causing build failure on
amd64.</para></item>
        </items>
      </change>

      <change from="2.18" to="2.18.1">
        <items name="Bug Fixes">
          <item><para>Fix run-time warnings about
gtk_tree_model_row_changed() when built with recent versions of
GTK+.</para></item>
          <item><para>gcc option -specs= must be run locally so that
it can read the local spec file.</para></item>
        </items>

        <items name="Portability">
          <item><para>Fix Solaris build problem</para></item>
          <item><para>Fix problem with reading hosts files in DOS CRLF
format.</para></item>
        </items>
      </change>

      <change from="2.17" to="2.18">
        <items name="Bug Fixes">
          <item><para>Fix longjmp() bug that can cause distcc to crash
when a timeout elapses.</para></item>
          <item><para>Fix compile-time problem with dcc_trace when
configured with --enable-rfc2553.</para></item>
          <item><para>Fix warning about warn_unused_result for older
versions of gcc.</para></item>
          <item><para>No timeout on local preprocessing or on
compilation.  No timeouts on DNS lookups other than whatever is built
in to the DNS resolver.  There are timeouts on network transmission
and on opening connections.</para></item>
          <item><para>Remove mmap() for receive of uncompressed data,
to avoid various problems.</para></item>
        </items>

        <items name="Changes">
          <item><para>The --allow option is now mandatory for daemon
mode.  As a security feature, distccd will refuse to run without an IP
access control list.</para></item>
          <item><para>conftest.* built by autoconf is always done
locally, to make configure tests faster and safer.</para></item>
        </items>

        <items name="Documentation">
          <item><para>Better description of use with
ccache.</para></item>
        </items>

        <items name="Portability">
          <item><para>Fix various warnings</para></item>
          <item><para>Fix Tru64 build problem</para></item>
        </items>
      </change>

      <change from="2.16" to="2.17">
        <items name="Features">
          <item><para>Performance improvements for
distccmon-gnome</para></item>
          <item><para>Added timeouts for connection to servers,
transmission of jobs and remote compilation. If the timeout expires,
the job is run locally. This should make distcc cope better if some or
all of the servers are unreachable or failing.</para></item>
          <item><para>Also add timeouts in server to kick out stalled
or disconnected clients</para></item>
        </items>

        <items name="Bug fixes">
          <item><para>If remote compilation fails because of a signal
in a later phase of the compilation causing an exit with code
&gt;=128, retry compilation locally</para></item>
        </items>

        <items name="Documentation">
          <item><para>Manpage fix</para></item>
        </items>

        <items name="Portability">
          <item><para>Cygwin portability fix for
WCOREDUMP</para></item>
        </items>
      </change>

      <change from="2.15" to="2.16">
        <items name="Security">
          <item><para>Fix bug that might cause IP-based access control
rules not to be interpreted correctly on 64-bit platforms
(CAN-2004-0601)</para></item>
        </items>

        <items name="Bug fixes">
          <item><para>Fix small memory leaks in distccmon-gnome and
distccmon-text</para></item>
        </items>

        <items name="Features">
          <item><para>Use a GNOME status bar with a grab handle for
distccmon-gnome</para></item>
        </items>

        <items name="Portability">
          <item><para>Better detection of systems with a popt library
installed but no popt.h</para></item>
          <item><para>Fix bug in reporting crashed daemon children
that showed up on systems without strsignal, such as Mac OS
10.2</para></item>
          <item><para>Update testdistcc.py to work on ia64
linux</para></item>
        </items>

        <items name="Internal">
          <item><para>Simplify dcc_log_child_exited</para></item>
          <item><para>Include copyright and licence in --version
output, as suggested by GNU programs</para></item>
        </items>
      </change>

      <change from="2.14" to="2.15">
        <items name="Bug fixes">
          <item><para>Fix crash bug in receiving LZO compressed data
into a mmapped file</para></item>
          <item><para>Remove redundant temporary file cleanup in
non-forking mode</para></item>
        </items>

        <items name="Features">
          <item><para>Client calculates and can display the overall
throughput in preprocessed bytes per second for remote
jobs</para></item>
        </items>

        <items name="Removals">
          <item><para>The deprecated fork-after-exec mode controlled
by the --no-prefork option has been removed</para></item>
          <item><para>mmap is no longer used for compressed data to
simplify the code</para></item>
        </items>

        <items name="Portability">
          <item><para>Additional fixes to Red Hat / Fedora
scripts</para></item>
        </items>

        <items name="Internal">
          <item><para>Daemon now chdirs to $TMPDIR at startup rather
than /. This allows dumping core, among other things.</para></item>
        </items>
      </change>

      <change from="2.13" to="2.14">
        <items name="Features">
          <item><para>The host file is looked ip in $DISTCC_DIR/hosts,
not hardcoded to ~/.distcc/hosts. The default for $DISTCC_DIR is still
~/.distcc</para></item>
          <item><para>Source file name is included in success/failure
messages, e.g.:</para>
          <screen>
distcc[6655] ERROR: compile ./cases/bad.c on cardhu failed
          </screen></item>
          <item><para>distcc can now be built with a build directory
separate from the source directory</para></item>
        </items>

        <items name="Documentation">
          <item><para>Add documentation of DISTCC_DIR, and other
fixes</para></item>
          <item><para>Slightly improved distcc --help</para></item>
        </items>

        <items name="Bug fixes">
          <item><para>Decompression buffer can dynamically resize to
allow for very gassy files</para></item>
        </items>

        <items name="Portability">
          <item><para>Add sample scripts for Red Hat /
Fedora</para></item>
          <item><para>mmap is always disabled on HP-UX, because the
inconsistent page case is a bit dangerous for the way distcc uses
mmap</para></item>
        </items>
      </change>

      <change from="2.12.1" to="2.13">
        <items name="Security">
          <item><para>Enforce IPv4 access control lists when the
daemon is listening on an IPv6 port. This only applies when the server
was compiled using --enable-rfc2553 and run with
--allow.</para></item>
        </items>

        <items name="Features">
          <item><para>Hash comments are allowed in host list
files</para></item>
        </items>

        <items name="Internal">
          <item><para>Use TCP_DEFER_ACCEPT on Linux to avoid some
wasted context switching when a new connection comes in to the
server</para></item>
        </items>

        <items name="Bug Fixes">
          <item><para>Some fixes for connections over SSH when built
using --enable-rfc2553</para></item>
          <item><para>Handle arguments like "-xcpp" and
"-Wa,-xarch=v8"</para></item>
          <item><para>Fix resource exhaustion when DISTCC_SAVE_TEMPS
is set</para></item>
          <item><para>Fix problems in running IPv6-enabled builds on
kernels without IPv6 support</para></item>
        </items>

        <items name="Documentation">
          <item><para>More instructions for distributors/packagers
</para></item>
        </items>

        <items name="Portability">
          <item><para>Portability patches</para></item>
          <item><para>Possibly fix mmap problem on HP-UX with
compressed transfers</para></item>
        </items>

        <items name="Testing">
          <item><para>Add test for compilation with
compression</para></item>
          <item><para>Testsuite portability patch</para></item>
        </items>
      </change>

      <note type="installation">
        <para>The <command>distccd</command> daemon requires a special
user to run as, "<command>distcc</command>". While optional, it is
recommended that the following entry be added to
<command>/etc/services</command>:</para>
        <screen>
pop3        110/tcp
distcc      3632/tcp            # distributed compiler
        </screen>
      </note>

      <note type="usage">
        <para>While distcc will work with the vendor compiler
depending on the compiler options, it is designed to work with
GCC.</para>
      </note>
    </notes>

    <changelog>
      <change date="2011 May 5" revision="3"
      author="Gary V. Vaughan" email="gary@thewrittenword.com">
        <item><para>Update bison dependency from 2.3 to
2.4.3</para></item>
        <item><para>Update gcc dependency from 4.2.4 to
4.4.6</para></item>
        <item><para>Update popt dependency from 1.14 to
1.16</para></item>
        <item><para>Update python dependency from 2.5.2 to
2.6.7</para></item>
        <item><para>Update python module from python-2.5.2 to
python-2.6.7</para></item>
      </change>
    </changelog>
  </program>
</programs>
