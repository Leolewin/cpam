<?xml version="1.0"?>
<programs>
<!DOCTYPE programs SYSTEM "sb-db.dtd">
  <program name="readline" version="6.2" revision="1">
    <build-name>${SB_PROG_NAME}-${SB_PROG_VER}</build-name>

    <install-name>lib${SB_PROG_NAME}62</install-name>

    <sources>
      <source checksum="67948acb2ca081f23359d0256e9a271c"
        checksum-type="md5" size="2277926"
        path="src/readline-6.2.tar.gz"/>
      <patch checksum="e31a0d27d79f0e618bf9c7ce0744f5e4"
        checksum-type="md5" size="1390"
        path="src/readline-6.2.readline62-001"/>
      <patch checksum="74e7797f5277a2856d714c50e081920e"
        checksum-type="md5" size="85565"
        path="src/readline-6.2.tww.patch"/>
      <patch checksum="64ef454cb9a694a008475003b19d51d6"
        checksum-type="md5" size="1216059"
        path="src/readline-6.2.auto.patch"/>
    </sources>

    <module name="default">
      <dependencies>
        <depend program="ncurses" var="NCURSES"
          install-name="ncurses57">v&gt;=5.7</depend>
      </dependencies>

      <validate>
        <depend program="readline" module="64bit"
          systype="*-aix*|*-hpux*|*-irix*|*-solaris*">v==6.2</depend>
        <depend program="readline"
          module="Term-ReadLine-Gnu-5.12.2">v==6.2</depend>
      </validate>

      <script-header>
<![CDATA[
_docdir="${SB_INSTALL_PREFIX}/doc"
]]>
      </script-header>

      <configure>
<![CDATA[
case "${SB_SYSTYPE}" in
*-aix*)
  CC=xlc CFLAGS="-O2 -qro -qroconst -qmaxmem=-1 -qarch=ppc"
  CC_LD_RT="-Wl,-blibpath:"
  LDFLAGS="-Wl,-brtl -Wl,-blibpath:/usr/lib" ;;
ia64*-hpux*)
  CC=cc CFLAGS="+O2 +Olit=all +Ofltacc +Oentrysched \
+Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+b," ;;
*-hpux11.[01]*)
  CC=cc CFLAGS="-z +O2 +Ofltacc +Olit=all +DAportable \
+Oentrysched +Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+s,+b," ;;
*-hpux*)
  CC=cc CFLAGS="-z +O2 +Ofltacc +Olit=all +Oentrysched \
+Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+s,+b," ;;
*-irix*)
  CC=cc CFLAGS="-Wl,-woff,84 -Wl,-woff,85 -woff 1009,1429 \
-use_readonly_const -G0 -rdata_shared -DEBUG:optimize_space=ON \
-O2 -OPT:Olimit=0"
  CC_LD_RT="-Wl,-rpath," ;;
i?86*-linux*)
  CFLAGS="-O2 -mtune=pentiumpro -march=pentiumpro"
  CC_LD_RT="-Wl,-rpath," ;;
*-linux*)
  CC_LD_RT="-Wl,-rpath," ;;
*-osf*)
  CC=cc CFLAGS="-O2 -arch ev5 -ieee -msym -readonly_strings"
  CC_LD_RT="-Wl,-rpath," ;;
i?86*-solaris*)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=pentium4"
  CC_LD_RT="-R" ;;
*-solaris2.8)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=ultra2 \
-xarch=v8plusa"
  CC_LD_RT="-R" ;;
*-solaris*)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=ultra2 \
-m32 -xarch=sparcvis"
  CC_LD_RT="-R" ;;
esac

${SHELL} ./configure CC="${CC:-gcc}" CFLAGS="${CFLAGS:--O2}" \
CPPFLAGS="${SB_VAR_NCURSES+-I${SB_VAR_NCURSES_INC}/ncurses}" \
LDFLAGS="${SB_VAR_NCURSES+-L${SB_VAR_NCURSES_LIB}} \
${SB_VAR_NCURSES+${CC_LD_RT}${SB_VAR_NCURSES_LIB}} \
${LDFLAGS+${LDFLAGS}}" --enable-static --enable-shared \
--with-ncurses ${ARGS+${ARGS}} \
--infodir="${SB_INSTALL_PREFIX}/info" \
--mandir="${SB_INSTALL_PREFIX}/man" --prefix=${SB_INSTALL_PREFIX}
]]>
      </configure>

      <install>
<![CDATA[
gmake install

${SB_PATH_INSTALL} -m 755 -o root -g 0 -d ${_docdir}/texinfo

# install texinfo source files
${SB_PATH_INSTALL} -m 644 -o root -g 0 doc/fdl.texi \
doc/history.texi doc/hstech.texi doc/hsuser.texi doc/rlman.texi \
doc/rltech.texi doc/rluser.texi doc/rluserman.texi \
doc/version.texi ${_docdir}/texinfo
]]>
      </install>
    </module>

    <module name="64bit"
    systype="*-aix*|*-hpux*|*-irix*|*-solaris*">
      <dependencies>
        <depend program="ncurses" var="NCURSES"
          module="64bit">v==5.7</depend>
      </dependencies>

      <script-header>
<![CDATA[
case "${SB_SYSTYPE}" in
*-aix*)
  _libdir=lib/ppc64 ;;
ia64*-hpux*)
  _libdir=lib/hpux64 ;;
*-hpux*)
  _libdir=lib/pa20_64 ;;
*-irix*)
  _libdir=lib64 ;;
i?86*-solaris*)
  _libdir=lib/amd64 ;;
*-solaris*)
  _libdir=lib/sparcv9 ;;
esac

case "${SB_SYSTYPE}" in
*-aix*)
  export OBJECT_MODE=64 ;;
esac
]]>
      </script-header>

      <configure>
<![CDATA[
case "${SB_SYSTYPE}" in
*-aix*)
  CC=xlc CFLAGS="-O2 -q64 -qro -qroconst -qmaxmem=-1"
  CC_LD_RT="-Wl,-blibpath:"
  LDFLAGS="-Wl,-brtl -Wl,-blibpath:/usr/lib" ;;
ia64*-hpux*)
  CC=cc CFLAGS="+O2 +Olit=all +Ofltacc +Oentrysched +DD64 \
+Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+b," ;;
*-hpux*)
  CC=cc CFLAGS="+O2 +Olit=all +Ofltacc +Oentrysched +DD64 \
+Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+s,+b,"

  case "${SB_SYSTYPE}" in
  *-hpux11.31)
    ARGS="--build=hppa64-hp-hpux11.31" ;;
  *-hpux11.23)
    ARGS="--build=hppa64-hp-hpux11.23" ;;
  *-hpux11.11)
    ARGS="--build=hppa64-hp-hpux11.11" ;;
  *-hpux11.00)
    ARGS="--build=hppa64-hp-hpux11.00" ;;
  esac ;;
*-irix*)
  CC=cc CFLAGS="-Wl,-woff,84 -Wl,-woff,85 -woff 1009,1429 \
-use_readonly_const -G0 -rdata_shared -DEBUG:optimize_space=ON \
-64 -mips4 -O2 -OPT:Olimit=0"
  CC_LD_RT="-Wl,-rpath," ;;
i?86*-solaris*)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -m64 -xarch=sse2"
  CC_LD_RT="-R" ;;
*-solaris2.8)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=generic \
-xarch=v9"
  CC_LD_RT="-R" ;;
*-solaris*)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=generic -m64 \
-xarch=sparc"
  CC_LD_RT="-R" ;;
esac

${SHELL} ./configure CC="${CC:-gcc}" CFLAGS="${CFLAGS:--O2}" \
${SB_VAR_NCURSES+CPPFLAGS="-I${SB_VAR_NCURSES_INC}/64/ncurses"} \
LDFLAGS="${SB_VAR_NCURSES+-L${SB_VAR_NCURSES}/${_libdir} \
${CC_LD_RT}${SB_VAR_NCURSES}/${_libdir}} ${LDFLAGS+${LDFLAGS}}" \
--enable-static --enable-shared --with-ncurses ${ARGS+${ARGS}} \
--libdir="${SB_INSTALL_PREFIX}/${_libdir}" \
--prefix=${SB_INSTALL_PREFIX}
]]>
      </configure>

      <install>
<![CDATA[
if [ ! -d ${SB_INSTALL_PREFIX}/lib/64 ]; then
  case "${SB_SYSTYPE}" in
  *-aix*|*-hpux*|*-solaris*)
    ln -s ./$(basename ${_libdir}) ${SB_INSTALL_PREFIX}/lib/64 ;;
  *-irix*)
    ln -s ../lib64 ${SB_INSTALL_PREFIX}/lib/64 ;;
  esac
fi

${SB_PATH_INSTALL} -m 755 -o root -g 0 -d \
${SB_INSTALL_PREFIX}/${_libdir}

gmake install-lib
]]>
      </install>
    </module>

    <module name="Term-ReadLine-Gnu-5.12.2">
      <build-name>Term-ReadLine-Gnu-1.20</build-name>

      <sources>
        <source checksum="fa33510193b89a2ada74fcef00816322"
          checksum-type="md5" size="69077"
          path="src/Term-ReadLine-Gnu-1.20.tar.gz"/>
        <patch checksum="0ae9d26a679a8c8f60d79c8791da6f83"
          checksum-type="md5" size="3558"
          path="src/Term-ReadLine-Gnu-1.20.tww.patch"/>
      </sources>

      <dependencies>
        <depend program="gcc" install-name="gcc44"
          add-path="prepend">v&gt;=4.4.6</depend>
        <depend program="ncurses" var="NCURSES"
          install-name="ncurses57">v&gt;=5.7</depend>
        <depend program="perl" var="PERL">v==5.12.2</depend>
        <depend program="readline" var="READLINE">v==6.2</depend>
      </dependencies>

      <script-header>
<![CDATA[
_install_prefix="${SB_INSTALL_PREFIX_LIB}/perl5122"
]]>
      </script-header>

      <configure>
<![CDATA[
case "${SB_SYSTYPE}" in
*-aix*)
  CC_LD_RT="-Wl,-blibpath:"
  LDFLAGS="-Wl,-brtl -Wl,-blibpath:/usr/lib" ;;
ia64*-hpux*)
  CC_LD_RT="-Wl,+b," ;;
*-hpux*)
  CC_LD_RT="-Wl,+s,+b," ;;
*-irix*|*-linux*|*-osf*)
  CC_LD_RT="-Wl,-rpath," ;;
*-solaris*)
  CC_LD_RT="-R" ;;
esac

${SB_VAR_PERL}/bin/perl Makefile.PL \
--ldflags="${CC_LD_RT}${SB_VAR_READLINE_LIB}:${SB_VAR_NCURSES_LIB} \
${LDFLAGS+${LDFLAGS}}" \
--includedir="${SB_VAR_NCURSES_INC} -I${SB_VAR_READLINE_INC}" \
--libdir="${SB_VAR_NCURSES_LIB} -L${SB_VAR_READLINE_LIB}" \
INSTALLARCHLIB=${_install_prefix} \
INSTALLSITEARCH=${_install_prefix} \
INSTALLSITELIB=${_install_prefix} \
PREFIX=${SB_INSTALL_PREFIX}
]]>
      </configure>

      <test>
<![CDATA[
gmake test

: ignore testsuite failures
]]>
      </test>

      <install>
<![CDATA[
gmake install

# install path for Perl's include.paths.d
${SB_PATH_INSTALL} -m 755 -o root -g 0 -d \
${_install_prefix}/include.paths.d
cat >${_install_prefix}/include.paths.d/99-${SB_PROG_NAME} <<_EOT_
${_install_prefix}
_EOT_
]]>
      </install>

      <uninstall>
<![CDATA[
rm -rf ${_install_prefix} \
${SB_INSTALL_PREFIX}/man/man3/Term::ReadLine::Gnu.3
]]>
      </uninstall>
    </module>

    <notes>
      <change from="6.1" to="6.2">
        <items name="Changes to Readline">
          <item><para>The history library does not try to write the
history filename in the current directory if $HOME is unset.  This
closes a potential security problem if the application does not specify
a history filename.</para></item>
          <item><para>New bindable variable `completion-display-width'
to set the number of columns used when displaying
completions.</para></item>
          <item><para>New bindable variable `completion-case-map' to
cause case-insensitive completion to treat `-' and `_' as
identical.</para></item>
          <item><para>There are new bindable vi-mode command names to
avoid readline's case- insensitive matching not allowing them to be
bound separately.</para></item>
          <item><para>New bindable variable
`menu-complete-display-prefix' causes the menu completion code to
display the common prefix of the possible completions before cycling
through the list, instead of after.</para></item>
        </items>
      </change>

      <change from="6.0" to="6.1">
        <items name="Changes to Readline">
          <item><para>The SIGWINCH signal handler now avoids calling
the redisplay code if one arrives while in the middle of
redisplay.</para></item>
          <item><para>Changes to the timeout code to make sure that
timeout values greater than one second are handled
better.</para></item>
          <item><para>Fixed a bug in the redisplay code that was
triggered by a prompt containing invisible characters exactly the
width of the screen.</para></item>
          <item><para>Fixed a bug in the redisplay code encountered
when running in horizontal scroll mode.</para></item>
          <item><para>Fixed a bug that prevented menu completion from
properly completing filenames.</para></item>
          <item><para>Fixed a redisplay bug caused by a multibyte
character causing a line to wrap.</para></item>
          <item><para>Fixed a bug that caused key sequences of two
characters to not be recognized when a longer sequence identical in
the first two characters was bound.</para></item>
          <item><para>Fixed a bug that caused history expansion to be
attempted on $'...' single-quoted strings.</para></item>
          <item><para>Fixed a bug that caused incorrect redisplay when
the prompt contained multibyte characters in an `invisible' sequence
bracketed by \[ and \].</para></item>
          <item><para>Fixed a bug that caused history expansion to
short-circuit after encountering a multibyte character.</para></item>
          <item><para>Fixed a bug that caused applications using the
callback interface to not react to SIGINT (or other signals) until
another character arrived.</para></item>
        </items>

        <items name="New Features in Readline">
          <item><para>New bindable function:
menu-complete-backward.</para></item>
          <item><para>In the vi insertion keymap, C-n is now bound to
menu-complete by default, and C-p to
menu-complete-backward.</para></item>
          <item><para>When in vi command mode, repeatedly hitting ESC
now does nothing, even when ESC introduces a bound key sequence.  This
is closer to how historical vi behaves.</para></item>
          <item><para>New bindable function: skip-csi-sequence.  Can
be used as a default to consume key sequences generated by keys like
Home and End without having to bind all keys.</para></item>
          <item><para>New application-settable function:
rl_filename_rewrite_hook.  Can be used to rewite or modify filenames
read from the file system before they are compared to the word to be
completed.</para></item>
          <item><para>New bindable variable: skip-completed-text,
active when completing in the middle of a word.  If enabled, it means
that characters in the completion that match characters in the
remainder of the word are "skipped" rather than inserted into the
line.</para></item>
          <item><para>The pre-readline-6.0 version of menu completion
is available as "old-menu-complete" for users who do not like the
readline-6.0 version.</para></item>
          <item><para>New bindable variable: echo-control-characters.
If enabled, and the tty ECHOCTL bit is set, controls the echoing of
characters corresponding to keyboard-generated signals.</para></item>
          <item><para>New bindable variable: enable-meta-key.
Controls whether or not readline sends the smm/rmm sequences if the
terminal indicates it has a meta key that enables eight-bit
characters.</para></item>
        </items>
      </change>

      <change from="5.2" to="6.0">
        <items name="Changes to Readline">
          <item><para>Fixed a number of redisplay errors in
environments supporting multibyte characters.</para></item>
          <item><para>Fixed bugs in vi command mode that caused motion
commands to inappropriately set the mark.</para></item>
          <item><para>When using the arrow keys in vi insertion mode,
readline allows movement beyond the current end of the line (unlike
command mode).</para></item>
          <item><para>Fixed bugs that caused readline to loop when the
terminal has been taken away and reads return -1/EIO.</para></item>
          <item><para>Fixed bugs in redisplay occurring when
displaying prompts containing invisible characters.</para></item>
          <item><para>Fixed a bug that caused the completion append
character to not be reset to the default after an
application-specified completion function changed it.</para></item>
          <item><para>Fixed a problem that caused incorrect
positioning of the cursor while in emacs editing mode when moving
forward at the end of a line while using a locale supporting multibyte
characters.</para></item>
          <item><para>Fixed an off-by-one error that caused readline
to drop every 511th character of buffered input.</para></item>
          <item><para>Fixed a bug that resulted in SIGTERM not being
caught or cleaned up.</para></item>
          <item><para>Fixed redisplay bugs caused by multiline prompts
with invisible characters or no characters following the final
newline.</para></item>
          <item><para>Fixed redisplay bug caused by prompts consisting
solely of invisible characters.</para></item>
          <item><para>Fixed a bug in the code that buffers characters
received very quickly in succession which caused characters to be
dropped.</para></item>
          <item><para>Fixed a bug that caused readline to reference
uninitialized data structures if it received a SIGWINCH before
completing initialzation.</para></item>
          <item><para>Fixed a bug that caused the vi-mode `last
command' to be set incorrectly and therefore
unrepeatable.</para></item>
          <item><para>Fixed a bug that caused readline to disable
echoing when it was being used with an output file descriptor that was
not a terminal.</para></item>
          <item><para>Readline now blocks SIGINT while manipulating
internal data structures during redisplay.</para></item>
          <item><para>Fixed a bug in redisplay that caused readline to
segfault when pasting a very long line (over 130,000
characters).</para></item>
          <item><para>Fixed bugs in redisplay when using prompts with
no visible printing characters.</para></item>
          <item><para>Fixed a bug that caused redisplay errors when
using prompts with invisible characters and numeric arguments to a
command in a multibyte locale.</para></item>
          <item><para>Fixed a bug that caused redisplay errors when
using prompts with invisible characters spanning more than two
physical screen lines.</para></item>
        </items>

        <items name="New Features in Readline">
          <item><para>A new variable, rl_sort_completion_matches;
allows applications to inhibit match list sorting (but beware: some
things don't work right if applications do this).</para></item>
          <item><para>A new variable, rl_completion_invoking_key;
allows applications to discover the key that invoked rl_complete or
rl_menu_complete.</para></item>
          <item><para>The functions rl_block_sigint and
rl_release_sigint are now public and available to calling applications
who want to protect critical sections (like redisplay).</para></item>
          <item><para>The functions rl_save_state and rl_restore_state
are now public and available to calling applications; documented rest
of readline's state flag values.</para></item>
          <item><para>A new user-settable variable, `history-size',
allows setting the maximum number of entries in the history
list.</para></item>
          <item><para>There is a new implementation of menu
completion, with several improvements over the old; the most notable
improvement is a better `completions browsing' mode.</para></item>
          <item><para>The menu completion code now uses the
rl_menu_completion_entry_function variable, allowing applications to
provide their own menu completion generators.</para></item>
          <item><para>There is support for replacing a prefix  of a
pathname with a `...' when displaying possible completions.  This is
controllable by setting the `completion-prefix-display-length'
variable.  Matches with a common prefix longer than this value have
the common prefix replaced with `...'.</para></item>
          <item><para>There is a new `revert-all-at-newline' variable.
If enabled, readline will undo all outstanding changes to all history
lines when `accept-line' is executed.</para></item>
        </items>
      </change>

      <note type="usage">
        <para>The Term::ReadLine Perl module is available in the
following directory:</para>
        <screen>
${SB_INSTALL_PREFIX}/lib/perl5122    # Perl 5.12.2
        </screen>

        <para>This directory is automatically added to the Perl
include.paths.d directory by the postinstall script.</para>
      </note>
    </notes>
  </program>
</programs>
