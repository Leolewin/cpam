<?xml version="1.0"?>
<programs>
<!DOCTYPE programs SYSTEM "sb-db.dtd">
  <program name="opencdk" version="0.6.6" revision="3">
    <build-name>${SB_PROG_NAME}-${SB_PROG_VER}</build-name>

    <install-name>lib${SB_PROG_NAME}06</install-name>

    <sources>
      <source checksum="813d62d7afe7b2c2d8f3df0a6c9d9331"
        checksum-type="md5" size="481904"
        path="src/opencdk-0.6.6.tar.bz2"/>
      <patch checksum="454f805bbcb29ea73f6a99f32793cf8b"
        checksum-type="md5" size="10980"
        path="src/opencdk-0.6.6.tww.patch"/>
      <patch checksum="14315a26634d22142c5477f90bef2c04"
        checksum-type="md5" size="1646109"
        path="src/opencdk-0.6.6.auto.patch"/>
    </sources>

    <dependencies>
      <depend program="pkgconfig" install-name="pkgconfig02"
        add-path="prepend" type="build">v&gt;=0.25</depend>
      <depend program="perl" add-path="prepend"
        type="build">v==5.12.2</depend>
    </dependencies>

    <script-header>
<![CDATA[
_docdir="${SB_INSTALL_PREFIX}/doc"
_datadir="${SB_INSTALL_PREFIX}/share"
]]>
    </script-header>

    <test auto-include="0">
<![CDATA[
gmake check
]]>
    </test>

    <module name="default">
      <dependencies replace="0">
        <depend program="libgpg-error" var="LIBGPG_ERROR"
          install-name="libgpgerror110">v==1.10</depend>
        <depend program="libgcrypt" var="LIBGCRYPT"
          install-name="libgcrypt14">v&gt;=1.4.6</depend>
        <depend program="zlib" var="LIBZ"
          install-name="libz12">v&gt;=1.2.5</depend>
      </dependencies>

      <validate>
        <depend program="opencdk" module="64bit"
          systype="*-aix*|*-hpux*|*-irix*|*-solaris*">v==0.6.6</depend>
      </validate>

      <script-header>
<![CDATA[
_docdir="${SB_INSTALL_PREFIX}/doc"
_datadir="${SB_INSTALL_PREFIX}/share"
]]>
      </script-header>

      <configure>
<![CDATA[
case "${SB_SYSTYPE}" in
*-aix*)
  CC=xlc CFLAGS="-O2 -qro -qroconst -qmaxmem=-1 -qarch=ppc"
  CC_LD_RT="-Wl,-blibpath:"
  LDFLAGS="-Wl,-brtl -Wl,-blibpath:/usr/lib" ;;
ia64*-hpux*)
  CC=cc CFLAGS="+O2 -z +Ofltacc +Olit=all +Oentrysched \
+Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+b," ;;
*-hpux11.[01]*)
  CC=cc CFLAGS="-Ae -z +O2 +Ofltacc +ESlit +DAportable \
+Oentrysched +Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+s,+b," ;;
*-hpux*)
  CC=cc CFLAGS="+O2 -z +Ofltacc +Olit=all +Oentrysched \
+Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+s,+b," ;;
*-irix*)
  CC=cc CFLAGS="-Wl,-woff,84 -Wl,-woff,85 -woff 1009,1429 \
-use_readonly_const -G0 -rdata_shared -DEBUG:optimize_space=ON \
-O2 -OPT:Olimit=0"
  CC_LD_RT="-Wl,-rpath," ;;
i?86*-linux*)
  CFLAGS="-O2 -mtune=pentiumpro -march=pentiumpro"
  CC_LD_RT="-Wl,-rpath," ;;
*-linux*)
  CC_LD_RT="-Wl,-rpath," ;;
*-osf*)
  CC=cc CFLAGS="-O2 -arch ev5 -msym -readonly_strings"
  CC_LD_RT="-Wl,-rpath," ;;
i?86*-solaris*)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=pentium4"
  CC_LD_RT="-R" ;;
*-solaris2.8)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=ultra2 \
-xarch=v8plusa"
  CC_LD_RT="-R" ;;
*-solaris*)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=ultra2 \
-m32 -xarch=sparcvis"
  CC_LD_RT="-R" ;;
esac

${SHELL} ./configure CC="${CC:-gcc}" CFLAGS="${CFLAGS:--O2}" \
CPPFLAGS="${SB_VAR_LIBZ+-I${SB_VAR_LIBZ_INC}}" \
LDFLAGS="${SB_VAR_LIBZ+-L${SB_VAR_LIBZ_LIB}} \
${SB_VAR_LIBZ+${CC_LD_RT}${SB_VAR_LIBZ_LIB}} \
${LDFLAGS+${LDFLAGS}}" \
PKG_CONFIG_PATH="${SB_VAR_LIBGCRYPT_LIB}/pkgconfig:\
${SB_VAR_LIBGPG_ERROR_LIB}/pkgconfig" \
--datadir=${_datadir} --disable-dependency-tracking  \
--libdir=${SB_INSTALL_PREFIX_LIB} --prefix=${SB_INSTALL_PREFIX}

gmake configure

${SB_PATH_SED} -i -e "\
s!-L\(\${libdir}\)!-L\1 ${CC_LD_RT}\1!" src/opencdk.pc
]]>
      </configure>

      <test auto-include="0">
<![CDATA[
gmake check
]]>
      </test>

      <install>
<![CDATA[
gmake install

${SB_PATH_INSTALL} -m 755 -o root -g 0 -d ${_docdir}/html
${SB_PATH_INSTALL} -m 644 -o root -g 0 doc/opencdk-api.html \
${_docdir}/html
]]>
      </install>
    </module>

    <module name="64bit"
    systype="*-aix*|*-hpux*|*-irix*|*-solaris*">
      <dependencies replace="0">
        <depend program="libgpg-error" var="LIBGPG_ERROR"
          install-name="libgpgerror110"
          module="64bit">v&gt;=1.10</depend>
        <depend program="libgcrypt" var="LIBGCRYPT"
          install-name="libgcrypt14"
          module="64bit">v&gt;=1.4.6</depend>
        <depend program="zlib" var="LIBZ" install-name="libz12"
          module="64bit">v&gt;=1.2.5</depend>
      </dependencies>

      <script-header replace="0">
<![CDATA[
case "${SB_SYSTYPE}" in
*-aix*)
  _libdir=lib/ppc64 ;;
ia64*-hpux*)
  _libdir=lib/hpux64 ;;
*-hpux*)
  _libdir=lib/pa20_64 ;;
*-irix*)
  _libdir=lib64 ;;
i?86*-solaris*)
  _libdir=lib/amd64 ;;
*-solaris*)
  _libdir=lib/sparcv9 ;;
esac

case "${SB_SYSTYPE}" in
*-aix*)
  export OBJECT_MODE=64 ;;
esac
]]>
      </script-header>

      <configure>
<![CDATA[
case "${SB_SYSTYPE}" in
*-aix*)
  CC=xlc CFLAGS="-O2 -qro -qroconst -q64 -qmaxmem=-1"
  CC_LD_RT="-Wl,-blibpath:"
  LDFLAGS="-Wl,-brtl -Wl,-blibpath:/usr/lib" ;;
ia64*-hpux*)
  CC=cc CFLAGS="+O2 -z +Ofltacc +Olit=all +Oentrysched +DD64 \
+Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+b," ;;
*-hpux*)
  CC=cc CFLAGS="+O2 -z +Ofltacc +Olit=all +Oentrysched +DD64 \
+Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+s,+b,"

  case "${SB_SYSTYPE}" in
  *-hpux11.31)
    ARGS="--build=hppa64-hp-hpux11.31" ;;
  *-hpux11.23)
    ARGS="--build=hppa64-hp-hpux11.23" ;;
  *-hpux11.11)
    ARGS="--build=hppa64-hp-hpux11.11" ;;
  *-hpux11.00)
    ARGS="--build=hppa64-hp-hpux11.00" ;;
  esac ;;
*-irix*)
  CC=cc CFLAGS="-Wl,-woff,84 -Wl,-woff,85 -woff 1009,1429 \
-use_readonly_const -G0 -rdata_shared -DEBUG:optimize_space=ON \
-64 -mips4 -O2 -OPT:Olimit=0"
  CC_LD_RT="-Wl,-rpath," ;;
i?86*-solaris*)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=opteron -m64 \
-xarch=sse2"
  CC_LD_RT="-R" ;;
*-solaris2.8)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=generic -xarch=v9"
  CC_LD_RT="-R" ;;
*-solaris*)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=generic -m64 \
-xarch=sparc"
  CC_LD_RT="-R" ;;
esac

${SHELL} ./configure CC="${CC:-gcc}" CFLAGS="${CFLAGS:--O2}" \
CPPFLAGS="${SB_VAR_LIBZ+-I${SB_VAR_LIBZ_INC}}" \
LDFLAGS="${SB_VAR_LIBZ+-L${SB_VAR_LIBZ}/${_libdir} ${CC_LD_RT}\
${SB_VAR_LIBZ}/${_libdir} }${LDFLAGS+${LDFLAGS}}" \
PKG_CONFIG_PATH="${SB_VAR_LIBGCRYPT}/${_libdir}/pkgconfig:\
${SB_VAR_LIBGPG_ERROR}/${_libdir}/pkgconfig" \
--datadir=${_datadir} --disable-dependency-tracking  \
--libdir=${SB_INSTALL_PREFIX}/${_libdir} --prefix=${SB_INSTALL_PREFIX}

gmake configure

${SB_PATH_SED} -i -e "\
s!-L\(\${libdir}\)!-L\1 ${CC_LD_RT}\1!" src/opencdk.pc
]]>
      </configure>

      <test auto-include="0">
<![CDATA[
gmake check
]]>
      </test>

      <install>
<![CDATA[
if [ ! -d ${SB_INSTALL_PREFIX}/lib/64 ]; then
  case "${SB_SYSTYPE}" in
  *-aix*|*-hpux*|*-solaris*)
    ln -s ./$(basename ${_libdir}) ${SB_INSTALL_PREFIX}/lib/64 ;;
  *-irix*)
    ln -s ../lib64 ${SB_INSTALL_PREFIX}/lib/64 ;;
  esac
fi

gmake -C src install-pkgconfigDATA install-libLTLIBRARIES
]]>
      </install>

      <uninstall>
<![CDATA[
rm -rf ${SB_INSTALL_PREFIX}/${_libdir}
]]>
      </uninstall>
    </module>

    <notes>
      <change from="0.6.5" to="0.6.6">
        <item><para>Slightly adjust the stream code. The check for
fflush is obmitted because the return value might be undefined. This
fixes a problem reported from the NetBSD team.</para></item>
        <item><para>Don't use __inline__ in src/cipher.c (breaks on
Sun CC).</para></item>
      </change>

      <change from="0.6.4" to="0.6.5">
        <item><para>Cleanups for the key export and import
functionality.</para></item>
        <item><para>Clarified the semantic of
cdk_pk_check_sigs.</para></item>
        <item><para>Now the by usage keydb function correctly finds
the self signature.</para></item>
      </change>

      <change from="0.6.3" to="0.6.4">
        <item><para>Make sure the test suite uses non-guessable file
names for temporary files</para></item>
        <item><para>Fix a problem in the file handling
code</para></item>
      </change>

      <change from="0.6.2" to="0.6.3">
        <item><para>Remove unused references in the opencdk config
script. This fixes an error because a variable were not
referenced.</para></item>
        <item><para>Interface changes relative to 0.6.2</para>
        <screen>
cdk_dek_get_cipher                 NEW
cdk_dek_get_mdc_flag               NEW
        </screen></item>
      </change>

      <change from="0.6.1" to="0.6.2">
        <item><para>Fix versioning script of the library</para></item>
        <item><para>Bug fixes for the remaining memory
leaks</para></item>
        <item><para>Better way to handle gcrypt
initialization</para></item>
        <item><para>Interface changes relative to 0.6.1</para>
        <screen>
cdk_lit_format_t                   NEW

functions:
cdk_pk_to_fingerprint              NEW
        </screen></item>
      </change>

      <change from="0.6.0" to="0.6.1">
        <item><para>The opencdk.def file is included in the
distribution archive, fixes build failures on mingw32.</para></item>
        <item><para>Some bug fixes for the mingw32 build in
combination with WINE.</para></item>
        <item><para>Now the decryption code uses the name in the
literal packet for the output file whenever this is
possible.</para></item>
        <item><para>Take care of absolute file names in literal
packets.</para></item>
      </change>

      <change from="0.5.13" to="0.6.0">
        <item><para>Dropped all internal random, cipher, digest libs
and only use gcrypt for such tasks. The library should only provide
functions dedicated to parsing and packet creation for the
protocol.</para></item>
        <item><para>Adjust code for the new Libgcrypt interface. Now
Libgcrypt &gt;1.2.2 is required to build the code.</para></item>
        <item><para>This new version introduces an API change and thus
incompatibilities to prior versions.</para></item>
        <item><para>Lots of cleanups all over the place. This also
includes simplification for various code parts.</para></item>
        <item><para>Better support for larger files</para></item>
        <item><para>Map the libgcrypt error directly and remove the
invalid CDK_Gcry_Error type.</para></item>
        <item><para>Add more regression tests for the various code
parts</para></item>
        <item><para>We do not support ElGamal signatures any
longer</para></item>
        <item><para>Merged patches from the other opencdk branch which
is currently used by GnuTLS</para></item>
        <item><para>Provide user callback for the stream. As a sample
implementation, socket callbacks are implemented and use in
cdk_stream_sockopen().</para></item>
        <item><para>Drop most of the rfc1991 legacy format. This means
we do not generate any rfc1991 data, but we still understand it. An
exception is the packet header output</para></item>
        <item><para>Removed gnulib interface for now because the lib
is currently not in use</para></item>
        <item><para>Interfaces changes relative to 0.5.x</para>
        <screen>
functions:
 cdk_stream_tmp                    CHANGED: is now cdk_stream_tmp_new
 cdk_stream_new_from_mem           CHANGED: new argument and return error code
 cdk_stream_control                CHANGED: is no available any longer
 cdk_stream_new_from_cbs           NEW
 cdk_stream_mmap_part              NEW
 cdk_keydb_new_from_file           NEW
 cdk_keydb_new_from_mem            NEW
 cdk_keydb_new_from_stream         NEW
 cdk_keydb_import                  CHANGED: second argument removed.
 cdk_keydb_pk_cache_sigs           DELETED
 cdk_kbnode_write_to_mem_alloc     NEW
 cdk_lib_startup                   NEW
 cdk_lib_shutdown                  NEW
 cdk_handle_set_keyring            NEW
 cdk_handle_get_verify_result      NEW
 cdk_subpkt_find_next              NEW
 cdk_subpkt_find_nth               NEW
 cdk_set_progress_handler          DELETED
 cdk_userid_get_pref_array         DELETED
 cdk_pk_encrypt                    CHANGED: last argument is now gcry_mpi_t
 cdk_pk_decrypt                    CHANGED: last argument is now gcry_mpi_t
 cdk_pk_get_mpi                    CHANGED: new argument nwritten.
 cdk_sk_get_mpi                    CHANGED: new argument nwritten.
 cdk_pk_release                    NEW
 cdk_sk_release                    NEW
 cdk_pubkey_to_sexp                NEW
 cdk_seckey_to_sexp                NEW
 cdk_armor_encode_buffer           NEW
 cdk_keygen_set_mdc_feature        DELETED
 cdk_keygen_set_algo_info          CHANGED: new argument usage.
 cdk_seskey_new                    DELETED
 cdk_seskey_free                   DELETED
 cdk_dek_encode_pkcs1              CHANGED: not public any longer.
 cdk_dek_decode_pkcs1              CHANGED: not public any longer.
 cdk_stream_tell                   CHANGED: return type is now off_t
 cdk_stream_seek                   CHANGED: argument is now off_t
 cdk_pk_check_self_sig             NEW
 
 constants:
 CDK_No_Data                       NEW
 CDK_CTL_TRUSTMODEL                DELETED
 CDK_CTL_FORCE_DIGEST              DELETED
 CDK_COMPRESS_BZIP2                NEW
 CDK_MD_SHA{256,384,512}           NEW
 CDK_MD_{TIGER, MD2}               DELETED
 CDK_CIPHER_{SAFER_SK128, DES_SK}  DELETED
 CDK_CTL_COMPAT                    DELETED
 
 structures:
 cdk_md_hd_t                       CHANGED: is now gcry_md_hd_t
 cdk_cipher_hd_t                   CHANGED: is now gcry_cipher_hd_t
 cdk_sesskey_t                     CHANGED: is now gcry_mpi_t
        </screen></item>
      </change>
    </notes>

    <changelog>
      <change date="2011 January 7" revision="3"
      author="Peter O'Gorman" email="pogma@thewrittenword.com">
        <item><para>Update pkgconfig dependency from 0.23 to
0.25</para></item>
        <item><para>Update perl dependency from 5.8.8 to
5.12.2</para></item>
        <item><para>Update libgpg-error dependency from 1.6 to
1.10</para></item>
        <item><para>Update libgcrypt dependency from 1.4.3 to
1.4.6</para></item>
        <item><para>Update zlib dependency from 1.2.3 to
1.2.5</para></item>
        <item><para>Add support for AIX 7.1</para></item>
      </change>

      <change date="2010 July 1" revision="2"
      author="Albert Chin-A-Young" email="china@thewrittenword.com">
        <item><para>Add support for RHEL 6</para></item>
      </change>
    </changelog>
  </program>
</programs>
