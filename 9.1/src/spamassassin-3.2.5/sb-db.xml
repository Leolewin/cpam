<?xml version="1.0"?>
<programs>
<!DOCTYPE programs SYSTEM "sb-db.dtd">
  <program name="spamassassin" version="3.2.5" revision="2">
    <install-name>${SB_PROG_NAME}325</install-name>

    <dependencies>
      <depend program="perl" var="PERL"
        add-path="prepend">v==5.12.2</depend>
    </dependencies>

    <module name="default">
      <build-name>Mail-SpamAssassin-${SB_PROG_VER}</build-name>

      <sources>
        <source checksum="695f9107b240383e48df8938f2de334e"
          checksum-type="md5" size="1011883"
          path="src/Mail-SpamAssassin-3.2.5.tar.bz2"/>
        <patch checksum="8b8d59e6f7bd0d6f9be2cb3580a7fc81"
          checksum-type="md5" size="510"
          path="src/Mail-SpamAssassin-3.2.5.bug6269.patch"/>
        <patch checksum="ea414e3c70e581bf6419326fa1d8586d"
          checksum-type="md5" size="7240"
          path="src/Mail-SpamAssassin-3.2.5.tww.patch"/>
      </sources>

      <dependencies replace="0">
        <depend program="Archive-Tar"
          module="5.12.2">v&gt;=1.78</depend>
        <depend program="IO-Zlib" module="5.12.2">v&gt;=1.10</depend>
        <depend program="spamassassin"
          module="Encode-Detect">v==3.2.5</depend>
        <depend program="spamassassin"
          module="IP-Country">v==3.2.5</depend>
        <depend program="spamassassin"
          module="Mail-DKIM">v==3.2.5</depend>
        <depend program="spamassassin"
          module="Mail-SPF">v==3.2.5</depend>
        <depend program="db" var="LIBDB" install-name="libdb47"
          module="DB_File-5.12.2">v&gt;=4.7.25</depend>
        <depend program="openssl" var="LIBOPENSSL"
          install-name="libopenssl10">v&gt;=1.0.0e</depend>
        <depend program="razor-agents" var="RAZOR"
          install-name="razor28">v&gt;=2.85</depend>
        <depend program="zlib" var="LIBZ"
          install-name="libz12">v&gt;=1.2.3</depend>
      </dependencies>

      <script-header>
<![CDATA[
_localstatedir="/var${SB_INSTALL_PREFIX}"

export PERL5LIB="${SB_VAR_RAZOR_LIB}:${SB_VAR_LIBDB_LIB}/perl5122:\
${SB_VAR_LIBZ_LIB}/perl5122:${SB_INSTALL_PREFIX_LIB}/perl"
]]>
      </script-header>

      <configure>
<![CDATA[
${SB_VAR_PERL}/bin/perl Makefile.PL PREFIX=${SB_INSTALL_PREFIX} \
CONTACT_ADDRESS=root ENABLE_SSL=yes \
DATADIR=${SB_INSTALL_PREFIX}/share \
SYSCONFDIR=${SB_INSTALL_PREFIX}/etc CONFDIR=${SB_INSTALL_PREFIX}/etc \
LOCALSTATEDIR=${_localstatedir} INSTALLSITELIB=${SB_INSTALL_PREFIX}/lib \
INSTALLSITEARCH=${SB_INSTALL_PREFIX}/lib

# The perl scripts run in taint mode (-T), so we must ensure to "use"
# any libraries outside of the default perl search path.
${SB_PATH_SED} -i -e "\
s!@@DBFILE@@!${SB_VAR_LIBDB_LIB}/perl5122!; \
s!@@COMPRESSZLIB@@!${SB_VAR_LIBZ_LIB}/perl5122!; \
s!@@PERLLIBDIR@@!${SB_INSTALL_PREFIX_LIB}/perl!; \
s!@@RAZOR@@!${SB_VAR_RAZOR}/lib!" \
spamd/spamd.raw spamassassin.raw sa-learn.raw sa-compile.raw \
sa-update.raw

# Some of the tests fail because they run the system perl.
${SB_PATH_SED} -i -e "\
s,^#!/usr/bin/perl,#!${SB_VAR_PERL}/bin/perl," build/*
]]>
      </configure>

      <build>
<![CDATA[
case "${SYSTYPE}" in
*-aix*)
  CC=xlc CFLAGS="-O2 -qro -qroconst -qmaxmem=-1 -qarch=ppc"
  CC_LD_RT="-Wl,-blibpath:"
  LDFLAGS="-Wl,-brtl -Wl,-blibpath:/usr/lib" ;;
ia64*-hpux*)
  CC=cc CFLAGS="-z +O2 +Ofltacc +Olit=all +Oentrysched \
+Odataprefetch +Onolimit"
  LDFLAGS="-Wl,+nodefaultrpath"
  CC_LD_RT="-Wl,+b," ;;
*-hpux10*|*-hpux11.[01]*)
  CC=cc CFLAGS="-Ae -z +O2 +Ofltacc +ESlit +DAportable \
+Oentrysched +Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+s,+b," ;;
*-hpux*)
  CC=cc CFLAGS="-z +O2 +Ofltacc +Olit=all +Oentrysched \
+Odataprefetch +Onolimit"
  CC_LD_RT="-Wl,+s,+b," ;;
*-irix*)
  CC=cc CFLAGS="-Wl,-woff,84 -Wl,-woff,85 -woff 1009,1429 \
-use_readonly_const -G0 -rdata_shared -DEBUG:optimize_space=ON \
-O2 -OPT:Olimit=0"
  CC_LD_RT="-Wl,-rpath," ;;
i?86*-linuxe3)
  CFLAGS="-O2 -mcpu=pentiumpro -march=pentiumpro"
  CC_LD_RT="-Wl,-rpath," ;;
i?86*-linux*|i?86-suse-linux*)
  CFLAGS="-O2 -mtune=pentiumpro -march=pentiumpro"
  CC_LD_RT="-Wl,-rpath," ;;
*-linux*)
  CC_LD_RT="-Wl,-rpath," ;;
*-osf*)
  # spamc does not appear to work without the -g.
  CC=cc CFLAGS="-O2 -g"
  CC_LD_RT="-Wl,-rpath," ;;
i?86*-solaris*)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=pentium4"
  CC_LD_RT="-R" ;;
*-solaris2.[678])
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=ultra2 \
-xarch=v8plusa"
  CC_LD_RT="-R" ;;
*-solaris*)
  CC=cc CFLAGS="-mr -Qn -xstrconst -xO2 -xtarget=ultra2 \
-m32 -xarch=sparcvis"
  CC_LD_RT="-R" ;;
esac

gmake SPAMC_CC="${CC:-gcc}" SPAMC_CFLAGS="${CFLAGS:--O2}" \
SPAMC_CPPFLAGS="-I${SB_VAR_LIBOPENSSL_INC} -I${SB_VAR_LIBZ_INC}" \
SPAMC_LDFLAGS="-L${SB_VAR_LIBOPENSSL_LIB} -L${SB_VAR_LIBZ_LIB} \
${CC_LD_RT}${SB_VAR_LIBOPENSSL_LIB}:${SB_VAR_LIBZ_LIB} \
${LDFLAGS+${LDFLAGS}}"
]]>
      </build>

      <test auto-include="0">
<![CDATA[
gmake test
]]>
      </test>

      <install>
<![CDATA[
gmake install

rm -rf ${SB_INSTALL_PREFIX}/lib/5.12.2 ${SB_INSTALL_PREFIX}/lib/auto

${SB_PATH_INSTALL} -m 755 -o root -g 0 -d ${_localstatedir} \
${_localstatedir}/run

# install additional documentation
${SB_PATH_INSTALL} -m 755 -o root -g 0 -d ${SB_INSTALL_PREFIX}/doc
${SB_PATH_INSTALL} -m 755 -o root -g 0 INSTALL README TRADEMARK \
USAGE ${SB_INSTALL_PREFIX}/doc

# Install a bayes DB directory
${SB_PATH_INSTALL} -m 755 -o root -g 0 -d ${_localstatedir}/bayes
]]>
      </install>

      <uninstall>
<![CDATA[
rm -rf ${_localstatedir} ${SB_INSTALL_PREFIX}
]]>
      </uninstall>
    </module>

    <module name="IP-Country">
      <build-name>IP-Country-2.27</build-name>

      <sources>
        <source checksum="32932280ee4729145e85e08dad5ab8c6"
          checksum-type="md5" size="207632"
          path="src/IP-Country-2.27.tar.gz"/>
      </sources>

      <configure>
<![CDATA[
${SB_VAR_PERL}/bin/perl Makefile.PL \
INSTALLARCHLIB="${SB_INSTALL_PREFIX_LIB}/perl" \
INSTALLSITEARCH="${SB_INSTALL_PREFIX_LIB}/perl" \
INSTALLSITELIB="${SB_INSTALL_PREFIX_LIB}/perl" \
PREFIX="${SB_INSTALL_PREFIX_LIB}/perl"
]]>
      </configure>

      <test>
<![CDATA[
gmake test || :
]]>
      </test>
    </module>

    <module name="Encode-Detect">
      <build-name>Encode-Detect-1.01</build-name>

      <sources>
        <source checksum="ee9faf55d7105c97b02b8ebe590819c7"
          checksum-type="md5" size="179698"
          path="src/Encode-Detect-1.01.tar.gz"/>
      </sources>

      <dependencies replace="0">
        <depend program="Module-Build"
          module="5.12.2">v&gt;=0.3800</depend>
        <depend program="gcc" install-name="gcc44"
          add-path="prepend">v&gt;=4.4.6</depend>
      </dependencies>

      <configure>
<![CDATA[
${SB_VAR_PERL}/bin/perl Build.PL \
--install_base=${SB_INSTALL_PREFIX} \
--install_path lib="${SB_INSTALL_PREFIX_LIB}/perl" \
--install_path arch="${SB_INSTALL_PREFIX_LIB}/perl" <<_EOT_
no
_EOT_
]]>
      </configure>

      <build>
<![CDATA[
./Build
]]>
      </build>

      <test>
<![CDATA[
./Build test
]]>
      </test>

      <install>
<![CDATA[
./Build install
]]>
      </install>
    </module>

    <module name="Mail-SPF">
      <build-name>Mail-SPF-v2.007</build-name>

      <sources>
        <source checksum="67dccdc91e3264679a0e17d493d3cc30"
          checksum-type="md5" size="101722"
          path="src/Mail-SPF-v2.007.tar.gz"/>
      </sources>

      <dependencies replace="0">
        <depend program="version" module="5.12.2">v&gt;=0.94</depend>
        <depend program="Error" module="5.12.2">v&gt;=0.17016</depend>
        <depend program="Module-Build"
          module="5.12.2">v&gt;=0.3800</depend>
        <depend program="Net-DNS-Resolver-Programmable"
          module="5.12.2">v&gt;=0.003</depend>
        <depend program="NetAddr-IP"
          module="5.12.2">v&gt;=4.044</depend>
      </dependencies>

      <configure>
<![CDATA[
${SB_VAR_PERL}/bin/perl Build.PL \
--install_path arch=${SB_INSTALL_PREFIX_LIB}/perl \
--install_path bindoc=${SB_INSTALL_PREFIX_LIB}/perl/man/man1 \
--install_path lib=${SB_INSTALL_PREFIX_LIB}/perl \
--install_path libdoc=${SB_INSTALL_PREFIX_LIB}/perl/man/man3 \
--install_path script=${SB_INSTALL_PREFIX_LIB}/perl/bin \
--install_path sbin=${SB_INSTALL_PREFIX_LIB}/perl/sbin \
--prefix ${SB_INSTALL_PREFIX_LIB}
]]>
      </configure>

      <build>
<![CDATA[
./Build
]]>
      </build>

      <test>
<![CDATA[
./Build test
]]>
      </test>

      <install>
<![CDATA[
./Build install
]]>
      </install>
    </module>

    <module name="Mail-DKIM">
      <build-name>Mail-DKIM-0.37</build-name>

      <sources>
        <source checksum="f3e84ec6b5e42d4cbcc7c42ea2900649"
          checksum-type="md5" size="85996"
          path="src/Mail-DKIM-0.37.tar.gz"/>
      </sources>

      <dependencies replace="0">
        <depend program="Crypt-OpenSSL-RSA"
          module="5.12.2">v&gt;=0.28</depend>
        <depend program="Digest-SHA"
          module="5.12.2">v&gt;=5.62</depend>
        <depend program="Error" module="5.12.2">v&gt;=0.17016</depend>
      </dependencies>

      <configure>
<![CDATA[
${SB_VAR_PERL}/bin/perl Makefile.PL \
INSTALLARCHLIB="${SB_INSTALL_PREFIX_LIB}/perl" \
INSTALLSITEARCH="${SB_INSTALL_PREFIX_LIB}/perl" \
INSTALLSITELIB="${SB_INSTALL_PREFIX_LIB}/perl" \
PREFIX="${SB_INSTALL_PREFIX_LIB}/perl"
]]>
      </configure>

      <test>
<![CDATA[
gmake test || :
]]>
      </test>
    </module>

    <notes>
      <note type="installation">
        <para>A startup script for <command>spamd</command>, a
lightweight SpamAssassin daemon used alongside
<command>spamc</command> to avoid the overhead of a fork/exec for each
incoming mail message, is provided. The default path to the
<command>spamd</command> PID file is
<command>/var${SB_INSTALL_PREFIX}/run/spamd.pid</command>. A different
path can be set with the <command>PID_FILE</command> variable in the
startup script.</para>
      </note>

      <note type="configuration">
        <para>SpamAssassin(TM) includes support for Vipul's Razor. DCC
support and pyzor support is not included.</para>
        <para>An empty directory is created at installation time for
possible use as the database directory for the Bayesian probabilities
database, "<command>/var${SB_INSTALL_PREFIX}/bayes</command>". The following
change must be made to the configuration file,
<command>${SB_INSTALL_PREFIX}/etc/local.cf</command>, to use this
directory as the path for the Bayesian database:</para>
        <screen>
bayes_path /var${SB_INSTALL_PREFIX}/bayes/db
use_bayes 1
        </screen>

        <para>To use Bayesian filtering on a per-user basis, set the
following variables in the configuration file,
<command>${SB_INSTALL_PREFIX}/etc/local.cf</command>:</para>
        <screen>
bayes_path ~/.bayes/db
use_bayes 1
        </screen>

        <para>Before the Bayesian filter can be effective against
detecting SPAM, several hundred to several thousand SPAM and non-SPAM
messages must be passed to the <command>sa-learn</command> command as
follows ("<command>--spam</command>" for SPAM messages and
"<command>--ham</command>" for non-SPAM messages):</para>
        <screen>
$ ${SB_INSTALL_PREFIX}/bin/sa-learn --ham --mbox \
--showdots &lt;non-SPAM mbox file&gt;
$ ${SB_INSTALL_PREFIX}/bin/sa-learn --spam --mbox \
--showdots &lt;SPAM mbox file&gt;
        </screen>

        <para>To use Vipul's Razor, set the following variables in the
configuration file,
<command>${SB_INSTALL_PREFIX}/etc/local.cf</command>:</para>
        <screen>
razor_timeout 10
use_razor2 1
        </screen>

        <para>To report SPAM to Vipul's Razor ("<command>spamassassin
-r</command>"), an identity must be created with the following
command. This creates <command>~/.razor/identity</command> with a
unique id.</para>
        <screen>
$ razor-admin -register
        </screen>
      </note>
    </notes>

    <changelog>
      <change date="2012 January 19" revision="2"
      author="Peter O'Gorman" email="pogma@thewrittenword.com">
        <item><para>Update Archive-Tar dependency from 1.48 to
1.78</para></item>
        <item><para>Update Crypt-OpenSSL-RSA dependency from 0.25 to
0.28</para></item>
        <item><para>Update Digest-SHA dependency from 5.45 to
5.62</para></item>
        <item><para>Update Error dependency from 0.17009 to
0.17016</para></item>
        <item><para>Update IO-Zlib dependency from 1.09 to
1.10</para></item>
        <item><para>Update Module-Build dependency from 0.33 to
0.3800</para></item>
        <item><para>Update NetAddr-IP dependency from 4.026 to
4.044</para></item>
        <item><para>Update openssl dependency from 0.9.8h to
1.0.0e</para></item>
        <item><para>Update version dependency from 0.74 to
0.94</para></item>
        <item><para>Update zlib dependency from 1.2.3 to
1.2.5</para></item>
        <item><para>Remove Compress-Raw-Zlib dependency</para></item>
      </change>
    </changelog>
  </program>
</programs>
